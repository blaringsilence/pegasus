{% extends 'layout.html' %}
{% block controllers %}
{% if isOwner %}
	{% if not isDone %}
	<button class='global-btn register-btn board-btn' title='Mark As Done' data-toggle='modal' data-target='#markAsDoneModal'><i class='fa fa-check'></i></button>
	{% endif %}
	<button class='global-btn register-btn board-btn' title='Edit Board' data-toggle='modal' data-target='#editModal'><i class='fa fa-pencil'></i></button>
	<button class='global-btn register-btn board-btn' title='Invite Others' data-toggle='modal' data-target='#inviteModal'><i class='fa fa-envelope'></i></button>

{% endif %}
{% endblock %}
{% block content %}
<div class='row'>
	<div class='col-xs-12' id='board-header'>
		<h2><span id='board-title'>{{title}}</span><small class='hidden-xs hidden-sm'> Created at: {{created_at}}. Done at: {{done_at}}</small></h2>
		{% if not session.logged_in %}<p class='text-center'>Welcome, {{email}}! You've been invited!</p>{% endif %}
		{% if isOwner %}You're the owner!{% endif %}
		{% if isDone %}<p>This board is done!</p>{% endif %}
	</div>
</div>
	<div class='row'>
		<div class='col-xs-12'>
			<div id='chat-board'>
			</div>
	<!--Chat box-->
	{% if canEdit and not isDone %}
			<form id='chat-form'>
				<div class='form-group'>
				<input type='hidden' name='_csrf_token' value='{{ csrf_token() }}'>
					<hr>
					<textarea class='form-control' name='message' id='chat-textarea' placeholder="SAY SOMETHING..."></textarea>
				</div>
			</form>
	{% endif %}
	<!--End Chat box-->

		</div>
	</div>


	
{% endblock %}
{% block controller_modals %}
{% if isOwner %}
{% if not isDone %}
<!--Mark As Done-->
		<div class="modal fade" id="markAsDoneModal" tabindex="-1" role="dialog" aria-labelledby="markAsDoneLabel">
		  <div class="modal-dialog" role="document">
		    <div class="modal-content">
		      <div class="modal-header">
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		        <h4 class="modal-title" id="markAsDoneLabel">Mark As Done</h4>
		      </div>
		      <div class="modal-body text-center">
				  <h4>Are you sure you want to mark this board as done?</h4>
				  <form id='mark-as-done-form'>
				  	<input type='hidden' name='_csrf_token' value='{{ csrf_token() }}'>
				  	<input type='hidden' name='boardID' value='{{ boardID }}'>
				  </form>
				  <button id='mark-as-done' class='global-btn half-btn'>Yes</button>
				  <button id='do-not-mark-as-done' class='global-btn half-btn'>No</button>
		      </div>
		    </div>
		  </div>
		</div>
		<!--End Mark As Done-->
{% endif %}
<!--Edit Board-->
		<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editLabel">
		  <div class="modal-dialog" role="document">
		    <div class="modal-content">
		      <div class="modal-header">
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		        <h4 class="modal-title" id="editLabel">Edit Board</h4>
		      </div>
		      <div class="modal-body">
				  <form id='edit-board-form'> <!--CHANGE-->
				  	<input name='_csrf_token' type='hidden' value="{{ csrf_token() }}">
				  	<input name='boardID' type='hidden' value="{{ boardID }}">
				  	<div class='form-group'>
				     <label for='title-modal'>Title</label>
				     <input type='text' class='form-control' id='title-modal' name='title' value='{{ title }}' required>
				    </div>
				     <button type='submit' class='global-btn full-btn' id='edit-button'>Save</button>
				  </form>
		      </div>
		    </div>
		  </div>
		</div>
		<!--End Edit Board-->
<!--Invite To Board-->
		<div class="modal fade" id="inviteModal" tabindex="-1" role="dialog" aria-labelledby="inviteLabel">
		  <div class="modal-dialog" role="document">
		    <div class="modal-content">
		      <div class="modal-header">
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		        <h4 class="modal-title" id="inviteLabel">Invite By Email</h4>
		      </div>
		      <div class="modal-body">
				  <form id='invite-form'> <!--CHANGE-->
				  	<input name='_csrf_token' type='hidden' value="{{ csrf_token() }}">
				  	<div class='form-group'>
				     <label for='email-modal'>Email</label>
				     <input type='email' class='form-control' id='email-modal' name='email'  placeholder='ENTER THEIR EMAIL' required>
				    </div>
				    <div class='form-group'>
					     <label for='type-modal'>Permission</label>
					     <div id='type-modal'>
					     	<div class="radio-inline">
							  <label><input type="radio" name="type" value='view' required>View only</label>
							</div>
							<div class="radio-inline">
							  <label><input type="radio" name="type" value='edit' required>Edit</label>
							</div>
						</div>
				    </div>
				     <button type='submit' class='global-btn full-btn' id='invite-button'>Invite</button>
				  </form>
		      </div>
		    </div>
		  </div>
		</div>
		<!--End Invite To Board-->


{% endif %}
{% endblock %}
{% block scripts %}
<script> // keeping it here because jinja-rendered urls below, for now.
	$(function() {
		// SCROLL TO BOTTOM OF CHAT

		// GET INVITE CODE IF ANY
			function getQueryParam(sParam){
				var sPageURL = window.location.search.substring(1);
				var sURLVariables = sPageURL.split('&');
				for(var i=0; i<sURLVariables.length; i++){
					var sParamName = sURLVariables[i].split('=');
					if(sParamName[0].toLowerCase() == sParam.toLowerCase()){
						return sParamName[1];
					}
				}
			}
			var INVITE = '-1';
			var temp = getQueryParam('invite'); // so we only call the function once
			if(temp){
				INVITE = temp;
			}

		// GET MESSAGES
			var B = {{ boardID }};
			var prev = 0;
			function getMessages(){
				$.ajax({
					type: 'GET',
					url: Flask.url_for('board_components', {boardID:B}),
					data: {
							invite: INVITE,
							number: prev
						}, 
					success: function(data){
					if(!data.error){ // has new messages
						for(var i=0; i<data.messages.length; i++){ 
						var username;
						if (data.messages[i].userID){
							var id = data.messages[i].userID; // get username from db
							$.ajax({
								type: 'GET',
								url: Flask.url_for('get_user', {userID:id}),
								async: false, // so we can actually set the username through it
								dataType: 'json',
								success: function(d){
									if(d.error == 'None'){
									username = d.username;
								}
								else // if username was not found/user was later deleted/etc, though deleting/deactivating should be 'soft'
									username = id;
								}
							});
						}
						else
							username = data.messages[i].userEmail;
							$('#chat-board').append('<p class="chat-message"> <span class="chat-username">' + username + '</span> said:<br> <span class="chat-message-details"></span></p>');
						var list = data.messages[i].content.split('\n');
						var final = list.join('<br>');
						$('.chat-message-details').last().html(final);
							
					}
					$("#chat-board").animate({ scrollTop: $('#chat-board').prop("scrollHeight")}, 500);
					prev+=data.messages.length;
					}
				}
			});
		}
		window.setInterval(getMessages, 1000);

		// SEND MESSAGE
			$('#chat-form').bind('submit', function(event){
				event.preventDefault();
				var message = $('#chat-textarea').val();
				if(!message)
					return false;
				$('#chat-textarea').prop('disabled', true); // disable the textarea once we send
				$.ajax({
					async: false,
					type: 'POST',
					url: Flask.url_for('board_components', {boardID:B}),
					data: {
					'_csrf_token': $("input[name='_csrf_token']").val(),
					'invite': INVITE,
					'message': message
					}, 
					success: function(data){
						if(data.error != 'None'){
							$('#board-error').remove();
							$('#board-header').append('<div class="alert alert-warning" id="board-error" role="alert">'+data.error+'</div>');
						}
						$("input[name='_csrf_token']").val(data.token);
						$('#chat-textarea').val('');
					},
					error: function(message){
						console.log(message);
					}
				}).always(function(){
					$('#chat-textarea').prop('disabled', false); // re-enable once everything is done and tokens are re-assigned
				});
			});
			$('#chat-textarea').keydown(function(event){ // submit chat when enter alone is pressed
				if(event.keyCode==13 && !event.shiftKey){
					$('#chat-form').submit();
					return false;
				}
			});


		// INVITE PEOPLE
	        $('#invite-form').bind('submit', function() {
	          $('#invite-msg').remove(); // if there were any previous errors
	          $.post(Flask.url_for('invite_user'), {
	            email: $('input[name="email"]').val(),
	            type: $('input[name="type"]:checked').val(),
	            _csrf_token: $('input[name="_csrf_token"]').val(),
	            boardID: {{ boardID }}
	          }, function(data) {
	            if(data.successful == 'true'){
	            	$('#inviteModal .modal-body').prepend('<div class="alert alert-success" id="invite-msg" role="alert">Successfully invited!</div>');
	            	document.getElementById("invite-form").reset();
	            }else{
	            	$('#inviteModal .modal-body').prepend('<div class="alert alert-warning" id="invite-msg" role="alert">'+data.error+'</div>')
	            }
	            $('input[name="_csrf_token"]').val(data.token); // replace all tokens in page
	          });
	          return false;
	        });

	        $("#inviteModal").on("hidden.bs.modal", function(){
	        	 document.getElementById("invite-form").reset();
	   			 $('#invite-msg').remove();
			});

	    // EDIT BOARD TITLE
			$('#edit-board-form').bind('submit', function(event){
				event.preventDefault();
				$('#edit-msg').remove(); // if there were any previous errors
				var data = $(this).serialize();
				$.post(Flask.url_for('edit_board'), data, function(data){
					if(data.error != 'None'){
						$('#editModal .modal-body').prepend('<div class="alert alert-warning" id="edit-msg" role="alert">' + data.error +'</div>');
	            	document.getElementById("edit-board-form").reset();
					}
					else{
						$('#editModal .modal-body').prepend('<div class="alert alert-success" id="edit-msg" role="alert">Successfully changed!</div>');
						newTitle = $('#title-modal').val();
						$('#board-title').text(newTitle);
					}
					$('input[name="_csrf_token"]').val(data.token);
				});
			});

			$("#editModal").on("hidden.bs.modal", function(){
	        	 document.getElementById("edit-board-form").reset();
	        	 var nt = $('#board-title').text();
	        	 $('#title-modal').val(nt);
	   			 $('#edit-msg').remove();
			});

		// MARK BOARD AS DONE
			$('#mark-as-done').click(function(){
				$('#mark-as-done-msg').remove();
				var data = $('#mark-as-done-form').serialize();
				$.post(Flask.url_for('mark_done'), data, function(data){ // make this synchronous?
					$("input[name='_csrf_token']").val(data.token);
					if(data.error=='None'){
						$('#markAsDoneModal .modal-body').html('<div class="alert alert-success" role="alert">Successfully marked as done!</div>');
					}
					else{
						$('#markAsDoneModal .modal-body').prepend('<div class="alert alert-warning" id="mark-as-done-msg" role="alert">'+data.error+'</div>');
					}
					
				});
			});
			$("#markAsDoneModal").on("hidden.bs.modal", function(){
	   			 $('#mark-as-done-msg').remove();
			});

	      });
	
</script>
{% endblock %}